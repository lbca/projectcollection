/**
 * yidao
 * created by 用车前端组
 */
"use strict";var root=window||{},util=root.util||{},Coupons=function(o){this.options=$.extend({sel:"",hrefParma:util.getHrefParma(),couponState:1,coutpClass:{1:"blue",2:""},couponType:{1:"管家券",2:"商家券"},viewDetails:{},curpg:1,len:15,tpage:0,iscrollPaging:null,msg:{m1:"未使用",m2:"添加优惠券",m3:"请输入优惠券编号",m4:"请输入优惠券密码",m5:"优惠券编号有误",m6:"您的优惠券密码不正确，<br>绑定失败",m7:"您的优惠券密码已被使用，<br>无法再次绑定",m8:"优惠券已过期",m9:"优惠券绑定操作频繁",m10:"添加成功",m11:"请输入优惠券号",m12:"请输入优惠券密码"},requestState:{save:!0}},o),this.sel=this.options.sel,this.el=$(this.sel)};$.extend(Coupons.prototype,{init:function(){var o=this;o.load(),o.addEvent()},load:function(){var o=this;o.options.hrefParma;o.getCoupons(o.options.couponState,o.options.curpg,o.options.len)},reLoadCoupons:function(){var o=this;o.options.curpg=1,o.options.tpage=0,o.options.iscrollPaging&&(o.options.iscrollPaging.scrollDestroy(),o.options.iscrollPaging=null),$("#list").html(""),o.getCoupons(o.options.couponState,o.options.curpg,o.options.len)},getCoupons:function(o,t,s){var i=this;util.api({surl:root.MB_API_PATH+"coupons",data:{coust:o,curpg:t,len:s},type:"get",async:!1,beforeSend:function(){},success:function(o){var t,s,n=o.rpco,a=o.body||{};switch(n){case 200:t=a.coulst||[],s=a.tpage||0,i.renderCoupons(a),0===s&&0===t.length&&$("#noList").show(),i.options.iscrollPaging?i.options.iscrollPaging.reLoadPagingOption({currentPage:i.options.curpg,totalPage:s}):(i.options.iscrollPaging=new IscrollPaging({totalPage:s,pageDataCount:i.options.len,loadDataFun:function(){i.options.curpg++,i.getCoupons(i.options.couponState,i.options.curpg,i.options.len)}}),i.options.iscrollPaging.init());break;case 404:$("#noList").show();break;default:util.tip("查询失败")}},complete:function(){}})},renderCoupons:function(o){var t=this,s=o.coulst||[],i="",n="";o.couuc&&$('#navTab a[value="1"]').find("span").html(t.options.msg.m1+"("+o.couuc+")");for(var a=0,e=s.length;a<e;a++)i=t.options.coutpClass[s[a].coutp]||"",n+='<div class="coupon '+i+' js-coupon" counum="'+s[a].counum+'"><span class="coupon-ltxt"><span class="dtc va-m">'+(t.options.couponType[s[a].coutp]||"")+'</span></span><div class="coupon-rblk"><span class="coupon-rblk-ltxt tod">¥<span class="big-txt">'+s[a].coumy/100+'</span></span><div class="coupon-hltxt tod">仅限'+s[a].couat+"服务使用</div>",s[a].coumat&&(n+='<div class="coupon-txt tod">满'+s[a].coumat+"元可用</div>"),n+='<div class="dashline-gray1"></div><div class="coupon-rblk-tip"><a class="coupon-ltip js-viewDetail" href="javascript:;"><i class="i i-ckxq"></i>查看详情</a><span class="coupon-rtip">'+util.formateDate(s[a].coucut,"yyyy.MM.dd")+"--"+util.formateDate(s[a].coucute,"yyyy.MM.dd")+"</span></div></div></div>",t.options.viewDetails[s[a].counum]=s[a].cpdtlst;$("#noList").hide(),1===$(".iscrollpading-pulltext").length?$(".iscrollpading-pulltext").before(n):$("#list").html(n).show()},_addCoupon:function(o,t){var s=this;util.api({surl:root.MB_API_PATH+"actcou",data:{counum:o,coupw:t},type:"post",beforeSend:function(){s.options.requestState.save=!1},success:function(o){var t=o.rpco;switch(t){case 200:util.tip(s.options.msg.m10,{iconClass:"i-chenggong"}),s.reLoadCoupons();break;case 40001:util.tip(s.options.msg.m5,{iconClass:"i-gantan"});break;case 40002:util.tip(s.options.msg.m6,{iconClass:"i-cha",duration:1500});break;case 40003:util.tip(s.options.msg.m7,{iconClass:"i-gantan",duration:1500});break;case 40004:util.tip(s.options.msg.m8,{iconClass:"i-gantan"});break;case 40005:util.tip(s.options.msg.m9,{iconClass:"i-gantan"});break;default:util.tip("添加失败",{iconClass:"i-cha"})}},complete:function(){s.options.requestState.save=!0}})},addCoupon:function(){var o=this,t=$(".dialog .alert-input input:eq(0)"),s=$(".dialog .alert-input input:eq(1)"),i=t.val(),n=s.val();return!o.options.requestState.save||(i?n?void o._addCoupon(i,n):(s.focus(),!1):(t.focus(),!1))},viewDetail:function(o){for(var t=this,s=t.options.viewDetails[o]||[],i="",n="",a=0,e=s.length;a<e;a++)i+=s[a].cdlb+s[a].cdtxt+"<br>";return!!i&&(n+='<div class="dialog js-couponDetail"><div class="tablecell"><div class="dialog-context"><div class="ttl">优惠券详情<span class="opctbig js-couponDetailClose"><i class="i i-delete2"></i></span></div><div class="txt">'+i+"</div></div></div></div>",void t.el.append(n))},addEvent:function(){var o=this,t=util.getClick();o.options.hrefParma;o.el.on(t,"#addCoupon",function(){util.prompt("",{title:o.options.msg.m2,inpuPlaceholderArray:[o.options.msg.m11,o.options.msg.m12],justOk:!1,okFn:function(){return o.addCoupon()},cancelFn:function(){}})}),o.el.on(t,"#navTab a",function(){o.options.couponState=$(this).attr("value"),o.reLoadCoupons()}),o.el.on(t,".js-viewDetail",function(){var t=$(this).closest(".js-coupon").attr("counum");o.viewDetail(t)}),o.el.on(t,".js-couponDetailClose",function(){$(this).closest(".js-couponDetail").remove()})}});