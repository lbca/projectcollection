/**
 * yidao
 * created by 用车前端组
 */
"use strict";var root=window||{},util=root.util||{};root.EMP_FUN=function(){};var Pay=function(o){this.options=$.extend({sel:"",hrefParma:util.getHrefParma(),otn:"",dodt:0,wxpc:{appId:"",timestamp:"",nonceStr:"",package:"",signType:"",paySign:"",success:this.paySuccess},coupon:{counum:0,coumy:0},canSelectCoupon:!1,mops:{1:"微信支付",2:"快捷支付"},msg:{m1:"订单信息错误",m2:"支付签名时间戳不能为空",m3:"支付签名随机串不能为空",m4:"统一支付值不能为空",m5:"签名方式不能为空",m6:"支付签名不能为空",m7:"无可用优惠券",m8:"支付单有误，不可继续操作"},requestState:{}},o),this.sel=this.options.sel,this.el=$(this.sel)};$.extend(Pay.prototype,{init:function(){var o=this;o.load(),o.addEvent()},load:function(){var o=this,t=o.options.hrefParma;t.counum&&(o.options.coupon.counum=t.counum),t.coumy&&(o.options.coupon.coumy=t.coumy),o.options.otn=t.otn||"",o.options.otn&&o.getOrderDetail(o.options.otn)},renderOrderDetail:function(o){var t=this,n=o.lmop||0,i=t.options.mops[n],e=o.odmy||0,p=o.amp||0,c=0,a=$("#coupon"),s=$("#coumy");o.odna&&$("#odna .value").html(o.odna),t.options.otn&&$("#otn .value").html(t.options.otn.replace(/_.*$/,"")),i&&$("#mopn .value").html(i),o.counum?(t.options.coupon={counum:o.counum,coumy:o.coumy},o.coumy&&s.html("-¥"+(o.coumy/100).toFixed(2)+"元"),a.show()):o.coucc&&(t.options.canSelectCoupon=!0,t.options.coupon.counum?(c=t.options.coupon.coumy,c&&s.html("-¥"+(c/100).toFixed(2)+"元")):s.html("未选择"),o.coucc&&$("#coucc").html("("+o.coucc+"张可用)"),o.coumcm&&$("#coumcm").html("最高可折扣"+(o.coumcm/100).toFixed(2)+"元").show(),a.show()),p-=c,p=p<0?0:p,p="¥"+parseFloat(p/100).toFixed(2),$("#amp .value").html(p),e="¥"+parseFloat(e/100).toFixed(2),$("#odmy .value").html(e)},getOrderDetail:function(o){var t=this;util.api({surl:root.WXP_API_PATH+"oddtal",data:{otn:o},type:"get",success:function(o){var n,i=o.rpco;switch(i){case 200:n=o.body||{},n.dodt&&(t.options.dodt=n.dodt),t.renderOrderDetail(n);break;default:util.comShow({txt:t.options.msg.m8,icl:"i-page"})}},complete:function(){util.remComShow()}})},WeChatPay:function(o){var t=this;return o.timestamp?o.nonceStr?o.package?o.signType?o.paySign?void wx.chooseWXPay({timestamp:o.timestamp,nonceStr:o.nonceStr,package:o.package,signType:o.signType,paySign:o.paySign,success:function(o){util.href("//wap.gomegj.com/spay/pay_notify?orderId="+t.options.otn)},cancel:function(){},fail:function(o){util.href("//wap.gomegj.com/spay/pay_notify?orderId="+t.options.otn)}}):(util.tip(t.options.msg.m6),!1):(util.tip(t.options.msg.m5),!1):(util.tip(t.options.msg.m4),!1):(util.tip(t.options.msg.m3),!1):(util.tip(t.options.msg.m2),!1)},_pay:function(o,t,n,i){var e=this,p={otn:o,timestamp:t};n&&(p.counum=n),i&&(p.coumy=i),util.api({surl:root.WXP_API_PATH+"odpyst",data:p,type:"get",beforeSend:function(){$("#toPay").attr("disabled",!0)},success:function(t){var n,i=t.rpco;switch(i){case 200:"undefined"==typeof t.body?util.href("/spay/pay_notify",{orderId:o}):(n=t.body||{},e.options.wxpc.nonceStr=n.nonceStr,e.options.wxpc.package=n.pack,e.options.wxpc.signType=n.signType,e.options.wxpc.paySign=n.paySign,e.WeChatPay(e.options.wxpc));break;default:util.tip("支付失败")}},error:function(){$("#toPay").removeAttr("disabled")}})},pay:function(){var o=this;return o.options.otn?void o._pay(o.options.otn,o.options.wxpc.timestamp,o.options.coupon.counum,o.options.coupon.coumy):(util.tip(o.options.msg.m1),!1)},addEvent:function(){var o=this,t=util.getClick();o.options.hrefParma;o.el.on(t,"#toPay:not([disabled])",function(){o.pay()}),o.el.on(t,"#coupon",function(){var t=location.pathname+"?otn="+o.options.otn;o.options.canSelectCoupon&&util.href("couponsuse.html",{cbu:t,otn:o.options.otn,dodt:o.options.dodt})})}});